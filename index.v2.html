<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google TV - Load+ TV</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            background: #0a0a2e;
            color: white;
            overflow: hidden;
        }

        #wraper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
            border-radius: 0;
            max-width: none;
            max-height: none;
            min-width: 100vw;
            min-height: 100vh;
            z-index: 9999;
            overflow-y: auto;
            overflow-x: hidden;
            background: #0a0a2e;
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            box-shadow: none;
            border: none;
            opacity: 1;
            position: relative;
        }

        #google-tv-carrusel {
            width: 100%;
            height: 100vh;
            background: transparent;
            border-radius: 0;
            margin: 0;
            padding: 0;
            position: relative;
            overflow: hidden;
        }

        #tarjetas-google-tv {
            display: flex;
            transition: transform 0.8s ease;
            height: 100vh;
            gap: 0;
            width: 100%;
            align-items: center;
            justify-content: flex-start;
        }

        .google-tv-card {
            background: transparent;
            border-radius: 20px;
            padding: 0;
            margin: 0;
            color: white;
            font-family: 'Roboto', Arial, sans-serif;
            position: relative;
            overflow: hidden;
            box-shadow: none;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
            flex-basis: 100%;
            min-width: 100%;
            height: 100vh;
            align-items: center;
        }

        .contenido-texto {
            position: absolute;
            z-index: 2;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: transparent;
            border-radius: 15px;
            padding: 20px;
            max-width: 600px;
            margin: 0;
            opacity: 1;
            top: 38vh;
            left: 4%;
            transform: translateY(-50%) scale(0.75);
            transform-origin: left center;
        }

        .google-tv-card h2 {
            font-size: 32px;
            font-weight: 700;
            color: white;
            margin: 0 0 15px 0;
            line-height: 1.2;
        }

        .google-tv-card .metadata {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            color: #ffffff;
        }

        .google-tv-card .metadata .bullet {
            color: #4285f4;
            font-weight: bold;
        }

        .google-tv-card .metadata img {
            height: 20px;
            width: auto;
            max-width: 60px;
            object-fit: contain;
            filter: brightness(0) invert(1);
            opacity: 0.9;
        }

        .google-tv-card p {
            font-size: 18px;
            color: #ffffff;
            line-height: 1.4;
            margin: 0 0 30px 0;
            opacity: 0.9;
            max-width: 500px;
        }

        .botones-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .botones-container.compacto { gap: 8px; }
        .botones-container.compacto a,
        .botones-container.compacto button {
            font-size: 13px;
            padding: 8px 14px;
            min-width: 90px;
        }

        .botones-container a,
        .botones-container button {
            background: #f0f0f0;
            color: #000000;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
            display: inline-block;
            min-width: 120px;
            text-align: center;
            outline: none;
        }

        .botones-container a:hover,
        .botones-container button:hover {
            background: #e0e0e0;
            transform: scale(1.05);
        }

        .botones-container a:focus,
        .botones-container button:focus {
            background: #4285f4;
            color: #ffffff;
            border-color: transparent;
            transform: scale(1.05);
            outline: 2px solid transparent;
        }

         .boton-siguiente-carrusel {
             position: absolute;
             right: 20px;
             top: 50%;
             transform: translateY(-50%);
             background: rgba(255, 255, 255, 0.2);
             color: white;
             border: 2px solid rgba(255, 255, 255, 0.3);
             border-radius: 50%;
             padding: 15px;
             font-size: 16px;
             font-weight: 500;
             cursor: pointer;
             display: flex;
             align-items: center;
             justify-content: center;
             transition: all 0.3s ease;
             z-index: 10;
             backdrop-filter: blur(10px);
             box-shadow: 0 4px 20px rgba(0,0,0,0.2);
             width: 54px;
             height: 54px;
         }

        .boton-siguiente-carrusel:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.05);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .boton-siguiente-carrusel:focus {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-50%) scale(1.05);
            border-color: transparent;
            box-shadow: 0 6px 25px rgba(255, 255, 255, 0.2);
            outline: 2px solid transparent;
        }

        /* Animación tipo tarjeta y sin blur cuando hay foco */
        .boton-siguiente-carrusel:focus, .boton-siguiente-carrusel:focus-visible {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.05);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            outline: 2px solid transparent;
            backdrop-filter: none;
        }

        .branding {
            font-size: 14px;
            color: #ffffff;
            margin-bottom: 10px;
            font-weight: 500;
        }

        /* Menú superior Google TV */
        .google-tv-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 56px;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 28px;
            background: transparent;
        }
        .menu-container {
            display: flex;
            gap: 14px;
            align-items: center;
            max-width: 1200px;
            width: 100%;
            position: relative;
            left: 8%;
        }
        .menu-button {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 18px;
            padding: 8px 17px;
            color: white;
            font-size: 11px;
            min-width: 84px;
            cursor: pointer;
            outline: none;
        }
        .menu-button:focus, .menu-button.active {
            background: #ffffff;
            color: #000000;
            font-family: 'Roboto', Arial, sans-serif;
        }
        .menu-button:focus { outline: 2px solid transparent; }

        /* Promo carousel (tarjetas de mañana) */
        #promo-carousel { position: fixed; top: 68vh; left: 4%; width: 80vw; z-index: 10002; pointer-events: none; }
        .promo-carousel-inner { position: relative; width: 100%; overflow: hidden; pointer-events: auto; }
        .promo-track { display: flex; width: 100%; }
        .promo-slide { flex: 0 0 100%; padding: 10px 12px; }
        #promo-carousel promo-match-card { transform: scale(0.5); transform-origin: left center; }
        .promo-nav { position: absolute; top: 50%; transform: translateY(-50%); width: 100%; display: flex; justify-content: space-between; pointer-events: none; }
        .promo-btn { pointer-events: auto; background: rgba(0,0,0,.35); color:#fff; border:1px solid rgba(255,255,255,.3); border-radius: 50%; width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter: blur(6px); }
        .promo-btn:focus { outline: 2px solid transparent; }
        .promo-dots { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); display:flex; gap:6px; }
        .promo-dot { width:9px; height:9px; border-radius:50%; background: rgba(255,255,255,.35); cursor: pointer; }
        .promo-dot.active { background: rgba(255,255,255,.85); }
        .promo-close { position: absolute; top: -8px; right: 8px; background: rgba(0,0,0,.45); color:#fff; border:1px solid rgba(255,255,255,.25); border-radius: 12px; padding: 4px 8px; cursor: pointer; font-size: 12px; }

        /* Estilos para la tarjeta especial */
        .tarjeta-especial .contenido-texto {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            max-width: 800px;
        }

        .tarjeta-especial h1 {
            font-size: 48px;
            font-weight: 700;
            color: white;
            margin: 0 0 20px 0;
            line-height: 1.2;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .tarjeta-especial h2 {
            font-size: 24px;
            font-weight: 400;
            color: #ffffff;
            margin: 0 0 30px 0;
            line-height: 1.3;
            opacity: 0.9;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .tarjeta-especial p {
            font-size: 20px;
            font-weight: 300;
            color: #ffffff;
            margin: 0 0 40px 0;
            opacity: 0.8;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .logos-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 20px;
            max-width: 600px;
        }

        .logo-canal {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .logo-canal img {
            height: 40px;
            width: auto;
            max-width: 80px;
            object-fit: contain;
            filter: brightness(0) invert(1);
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .logo-canal:hover img {
            opacity: 1;
        }

        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .google-tv-card h2 {
                font-size: 24px;
            }

            .google-tv-card p {
                font-size: 16px;
            }

            .contenido-texto {
                left: 10%;
                max-width: 80%;
            }

            .botones-container {
                flex-direction: column;
            }

            .botones-container a,
            .botones-container button {
                min-width: 100%;
            }
        }

        /* Responsive para diferentes escalas */
        @media (max-width: 1200px) {
            #wraper {
                background-size: 100% 100%;
                background-position: center;
            }
        }

        @media (max-width: 768px) {
            #wraper {
                background-size: 100% 100%;
                background-position: center;
            }
        }

        @media (max-width: 480px) {
            #wraper {
                background-size: 100% 100%;
                background-position: center;
            }
        }

        /* Para pantallas muy grandes */
        @media (min-width: 1920px) {
            #wraper {
                background-size: 100% 100%;
                background-position: center;
            }
        }

        /* Para escalas específicas */
        @media (min-resolution: 2dppx) {
            #wraper {
                background-size: 100% 100%;
                background-position: center;
            }
        }

        /* Asegurar que el fondo siempre cubra toda la pantalla */
        @media (orientation: landscape) {
            #wraper {
                background-size: 100% 100%;
                background-position: center;
            }
        }

        @media (orientation: portrait) {
            #wraper {
                background-size: 100% 100%;
                background-position: center;
            }
        }

        /* Específico para Android y dispositivos móviles */
        @media screen and (max-width: 1080px) and (max-height: 1920px) {
            #wraper {
                background-size: cover;
                background-position: center;
                background-attachment: scroll;
            }
            
            .contenido-texto {
                left: 4%;
                max-width: 90%;
                top: 38vh;
                transform: translateY(-50%) scale(0.75);
                transform-origin: left center;
            }
            
            .google-tv-card h2 {
                font-size: 28px;
            }
            
            .google-tv-card p {
                font-size: 16px;
            }
        }

        /* Para Android específicamente */
        @media screen and (max-width: 1920px) and (max-height: 1080px) {
            #wraper {
                background-size: cover;
                background-position: center;
                background-attachment: scroll;
            }
        }

        /* Para dispositivos táctiles */
        @media (pointer: coarse) {
            #wraper {
                background-attachment: scroll;
            }
            
            .boton-siguiente-carrusel {
                width: 60px;
                height: 60px;
                font-size: 18px;
            }
            
            .menu-button {
                padding: 12px 20px;
                font-size: 13px;
                min-width: 90px;
            }
        }

        /* Para Android Chrome */
        @media screen and (-webkit-min-device-pixel-ratio: 1) {
            #wraper {
                background-attachment: scroll;
                background-size: cover;
            }
        }

        /* Específico para Android */
        @media screen and (max-device-width: 1920px) and (max-device-height: 1080px) {
            #wraper {
                background-size: cover;
                background-position: center;
                background-attachment: scroll;
            }
        }

        /* Para dispositivos Android con viewport específico */
        @media screen and (max-width: 1920px) and (max-height: 1080px) and (-webkit-min-device-pixel-ratio: 1) {
            #wraper {
                background-size: cover;
                background-position: center;
                background-attachment: scroll;
            }
        }
    </style>
</head>
<body>
    <!-- Menú superior Google TV -->
    <div class="google-tv-menu">
        <div class="menu-container">
            <button class="menu-button" tabindex="0">Buscar</button>
            <button class="menu-button" tabindex="0">Para ti</button>
            <button class="menu-button" tabindex="0">En vivo</button>
            <button class="menu-button" tabindex="0">Películas</button>
            <button class="menu-button" tabindex="0">Series</button>
            <button class="menu-button" tabindex="0">Aplicaciones</button>
            <button class="menu-button" tabindex="0">Biblioteca</button>
        </div>
    </div>
    <div id="wraper">
        <!-- Promo carousel (eventos del día siguiente) -->
        <div class="promo-title" style="position: absolute; top: 384.912px; left: 10%; transform: translateX(-50%); font-size: 15.75px; font-weight: bold; color: white; text-align: center; z-index: 10002;">Partidos De mañana</div>
        <div id="promo-carousel" aria-live="polite" hidden>
            <div class="promo-carousel-inner">

                <div class="promo-track" id="promoTrack"></div>
                <div class="promo-nav">
                    <button class="promo-btn" id="promoPrev" aria-label="Anterior" style="display: none;">❮</button>
                    <button class="promo-btn" id="promoNext" aria-label="Siguiente" style="display: none;">❯</button>
                </div>
                <div class="promo-dots" id="promoDots"></div>
            </div>
        </div>
        <div id="google-tv-carrusel">
            <div id="tarjetas-google-tv">
                <!-- Los eventos se cargarán dinámicamente desde la API -->
                <div class="google-tv-card" style="display: flex; align-items: center; justify-content: center;">
                    <div class="contenido-texto" style="text-align: center;">
                        <div class="branding">Google TV</div>
                        <h2>Cargando eventos...</h2>
                        <p>Obteniendo la información más reciente de la agenda deportiva</p>
                    </div>
                </div>
            </div>

            <!-- Indicador de página actual -->
            <div id="indicador-pagina" style="
                position: absolute;
                bottom: 508px;
                left: 5%;
                transform: translateX(-50%);
                display: flex;
                gap: 8px;
                z-index: 10;
            ">
                <!-- Los indicadores se generarán dinámicamente -->
            </div>

            <button class="boton-siguiente-carrusel" tabindex="0" aria-label="Siguiente evento">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 5L15 12L8 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // Variables globales
        let paginaActual = 0;
        let autoPlayInterval = null;
        let hayFoco = false;
        let inactividadTimer = null;
        let ultimaActividad = Date.now();
        let carruselContainer = null;
        let tarjetasContainer = null;
        let eventosData = [];

        // Esperar (promesa) para backoff
        function esperar(ms){ return new Promise(res => setTimeout(res, ms)); }

        // Función para cargar datos del JSON de la API (sin caché)
        async function cargarEventosAPI() {
            const apiUrl = 'https://deporte-libre.click/schedule/schedule-generated.php';
            async function fetchJson(url){
                const r = await fetch(url, { cache: 'no-store' });
                if(!r.ok) throw new Error('HTTP '+r.status);
                return r.json();
            }
            const maxIntentos = 5;
            const baseDelay = 800; // ms
            for (let intento = 1; intento <= maxIntentos; intento++) {
                try {
                    console.log(`🔄 Intento ${intento}/${maxIntentos}: Deporte-Libre API...`);
                    let data;
                    try {
                        data = await fetchJson(apiUrl);
                    } catch (e) {
                        // Fallback proxy si hay CORS o falla directa
                        const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(apiUrl);
                        data = await fetchJson(proxyUrl);
                    }
                    // Transformar a formato interno simple (solo fútbol)
                    const eventos = [];
                    Object.keys(data || {}).forEach(dayLabel => {
                        const categories = data[dayLabel] || {};
                        Object.keys(categories).forEach(cat => {
                            if (!/soccer|futbol|fútbol/i.test(String(cat))) return; // Solo fútbol
                            const arr = categories[cat] || [];
                            arr.forEach(ev => {
                                const channels = Array.isArray(ev.channels) ? ev.channels : Object.values(ev.channels||{});
                                eventos.push({
                                    hour: String(ev.time || '').padStart(5,'0'),
                                    description: ev.event || '',
                                    channels: channels.map(ch => ({ channel_name: String(ch.channel_name||'').trim(), channel_id: String(ch.channel_id||'').trim() })),
                                    category: cat
                                });
                            });
                        });
                    });
                    if (eventos.length > 0) {
                        eventosData = eventos;
                        console.log(`✅ ${eventosData.length} eventos de fútbol cargados (intento ${intento})`);
                        return eventosData;
                    }
                    console.warn(`⚠️ Sin eventos tras intento ${intento}. Reintentando...`);
                } catch (error) {
                    console.warn(`❌ Error en intento ${intento}:`, error);
                }
                // Backoff incremental
                await esperar(baseDelay * intento);
            }
            console.error('❌ No se pudieron cargar eventos tras múltiples intentos');
            return [];
        }

        // Utilidad: formatear hora a HH:MM y convertir a minutos (acepta HH:MM o HH:MM:SS)
        function formatearHora(horaStr) {
            if (!horaStr || typeof horaStr !== 'string') return '';
            const partes = horaStr.split(':');
            if (partes.length >= 2) {
                const h = partes[0].padStart(2, '0');
                const m = partes[1].padStart(2, '0');
                return `${h}:${m}`;
            }
            return horaStr;
        }

        // Función para corregir el desfase de 1 hora en FTVHD API
        function corregirHoraDesfase(horaStr) {
            if (!horaStr || typeof horaStr !== 'string') return horaStr;
            const partes = horaStr.split(':');
            if (partes.length >= 2) {
                let h = parseInt(partes[0], 10);
                const m = parseInt(partes[1], 10);
                if (isNaN(h) || isNaN(m)) return horaStr;
                
                // Restar 1 hora (corregir desfase)
                h = h - 1;
                if (h < 0) h = 23; // Si pasa de 00:00, ir a 23:00 del día anterior
                
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            }
            return horaStr;
        }

        function convertirHoraAMinutos(horaStr) {
            if (!horaStr || typeof horaStr !== 'string') return Number.POSITIVE_INFINITY;
            const partes = horaStr.split(':');
            if (partes.length < 2) return Number.POSITIVE_INFINITY;
            const h = parseInt(partes[0], 10);
            const mm = parseInt(partes[1], 10);
            if (isNaN(h) || isNaN(mm)) return Number.POSITIVE_INFINITY;
            return h * 60 + mm;
        }

        // Convertir una hora HH:MM en GMT+0 a una zona con offset fijo en horas (p.ej. Guatemala -6)
        function convertirHoraDesdeGMT0(horaStr, offsetHoras) {
            if (!horaStr || typeof horaStr !== 'string') return '';
            const partes = horaStr.split(':');
            if (partes.length < 2) return horaStr;
            const h = parseInt(partes[0], 10);
            const m = parseInt(partes[1], 10);
            if (isNaN(h) || isNaN(m)) return horaStr;
            let total = h * 60 + m + (offsetHoras * 60);
            total = (total % 1440 + 1440) % 1440; // normalizar 0..1439
            const hh = String(Math.floor(total / 60)).padStart(2, '0');
            const mm = String(total % 60).padStart(2, '0');
            return `${hh}:${mm}`;
        }

        // Función para crear tarjeta desde datos de la API
        async function crearTarjetaDesdeAPI(evento) {
            const tarjeta = document.createElement('div');
            tarjeta.className = 'google-tv-card';

            // Datos desde deporte-libre
            const hora = convertirHoraDesdeGMT0(String(evento?.hour || ''), -6); // GMT+0 -> Guatemala (UTC-6)
            const descripcion = String(evento?.description || '');
            const categoriaTitulo = String(evento?.category || 'Deportes');
            const channels = Array.isArray(evento?.channels) ? evento.channels : [];

            // Título (intenta extraer equipos si hay separadores comunes)
            let tituloEquipos = descripcion;
            if (descripcion.includes(':')) {
                const partes = descripcion.split(':');
                if (partes.length > 1) {
                    tituloEquipos = partes[1].trim();
                }
            }
            if (descripcion.includes(' - ')) {
                const partes = descripcion.split(' - ');
                if (partes.length > 1) {
                    tituloEquipos = partes[1].trim();
                }
            }
            tituloEquipos = tituloEquipos.replace(/\n/g, ' ').replace(/\t/g, ' ').trim();

            // Cargar configuraciones de imágenes/logos (remoto/local)
            const config = await (async () => {
                try { return await fetch('https://loadplus.netlify.app/configuracion-imagenes.json?_t=' + Date.now(), { cache: 'no-store' }).then(r => r.json()); } catch(_) {}
                try { return await fetch('./configuracion-imagenes.json?_t=' + Date.now(), { cache: 'no-store' }).then(r => r.json()); } catch(_) {}
                return null;
            })();

            // Imagen de fondo
            const imgFondo = config ? (function obtenerImagenFondoLocal(titulo, conf){
                const t = (titulo||'').toLowerCase();
                if (conf?.equipos_especificos) {
                    for (const [eq, cfg] of Object.entries(conf.equipos_especificos)) {
                        if (t.includes(eq.toLowerCase())) { const a=cfg.urls||[]; if (a.length) return a[Math.floor(Math.random()*a.length)]; }
                    }
                }
                if (conf?.imagenes_eventos) {
                    for (const [cat, cfg] of Object.entries(conf.imagenes_eventos)) {
                        if (t.includes(cat.toLowerCase())) { const a=cfg.urls||[]; if (a.length) return a[Math.floor(Math.random()*a.length)]; }
                    }
                }
                const gen = conf?.imagenes_generales; if (Array.isArray(gen) && gen.length) return gen[Math.floor(Math.random()*gen.length)];
                return 'https://i.imgur.com/3tkeh6s.png';
            })(descripcion, config) : 'https://i.imgur.com/3tkeh6s.png';
            tarjeta.setAttribute('data-imagen-fondo', imgFondo);

            // Logos de canales basados en channel_name y configuración local
            const logosCanales = (function obtenerLogosPorNombre(titulo, channelList, conf){
                if (!conf || !conf.logos_canales) return [];
                const encontrados = [];
                const familiasCanales = { 'espn': ['espn','espn premium ar','espn premium','espn2','espn 2'], 'disney': ['disney+','disney +'], 'tvhd': ['tvhd','tvhd '], 'eventos': ['eventos','eventos '] };
                const familiaDe = (n)=>{ const s=n.toLowerCase(); for (const [f,ms] of Object.entries(familiasCanales)) if (ms.some(m=>s.includes(m))) return f; return s; };
                const usadas = new Set();
                const tituloLower = (titulo||'').toLowerCase();
                const nombres = channelList.map(ch => String(ch.channel_name||'')).filter(Boolean);
                // Por nombre de canal
                nombres.forEach(name => {
                    for (const [canal,cfg] of Object.entries(conf.logos_canales)) {
                        if (name.toLowerCase().includes(canal.toLowerCase())) {
                            const fam=familiaDe(canal);
                            if (!usadas.has(fam)) { usadas.add(fam); encontrados.push({url:cfg.url,alt:cfg.alt||canal,descripcion:cfg.descripcion||canal}); }
                        }
                    }
                });
                // Por coincidencia en el título
                for (const [canal,cfg] of Object.entries(conf.logos_canales)) {
                    if (encontrados.length>=5) break;
                    if (tituloLower.includes(canal.toLowerCase())) { const fam=familiaDe(canal); if (!usadas.has(fam)) { usadas.add(fam); encontrados.push({url:cfg.url,alt:cfg.alt||canal,descripcion:cfg.descripcion||canal}); } }
                }
                return encontrados.slice(0,5);
            })(descripcion, channels, config);

            // Botones de canales → miztv
            const botonesHTML = (channels && channels.length)
                ? channels.map(ch => {
                    const id = ch.channel_id || '';
                    const nm = ch.channel_name || 'Ver';
                    const href = `https://miztv.top/total/stream-${id}.php`;
                    return `<a href="${href}" tabindex="0" role="button">${nm}</a>`;
                }).join('')
                : '<a href="#" tabindex="0" role="button">Ver evento</a>';

            const esCompacto = (channels && channels.length > 5);

            const contenidoHTML = `
                <div class="contenido-texto">
                    <div class="branding">Google TV</div>
                    <h2>${tituloEquipos}</h2>
                    <div class="metadata">
                        <span>${hora}</span>
                        <span class="bullet">•</span>
                        <span>${categoriaTitulo}</span>
                        ${logosCanales.map(logo => `<span class=\"bullet\">•</span><img src=\"${logo.url}\" alt=\"${logo.alt}\" title=\"${logo.descripcion}\">`).join('')}
                    </div>
                    <p>${(config?.descripciones_generales?.futbol || config?.descripciones_generales?.generico || ['Disfruta del mejor contenido'])[0]}</p>
                    <div class="botones-container${esCompacto ? ' compacto' : ''}">
                        ${botonesHTML}
                    </div>
                </div>
            `;

            tarjeta.innerHTML = contenidoHTML;
            return tarjeta;
        }

        // Función para crear carrusel dinámico
        async function crearCarruselDinamico() {
             // Cargar datos de la API
             const eventos = await cargarEventosAPI();
             
             // Filtrar eventos que ya pasaron su hora (horario de Guatemala UTC-6)
             const ahora = new Date();
             // Obtener hora en zona horaria de Guatemala
             const horaGuatemala = new Date(ahora.toLocaleString("en-US", {timeZone: "America/Guatemala"}));
             const horaActual = horaGuatemala.getHours() * 60 + horaGuatemala.getMinutes(); // Convertir a minutos
             
             const eventosFiltrados = eventos.filter(ev => {
                 const horaLocal = convertirHoraDesdeGMT0(String(ev?.hour||''), -6);
                 const horaEvento = convertirHoraAMinutos(horaLocal);
                 // Solo mostrar eventos que aún no han pasado (con margen de 2 horas)
                 return horaEvento > horaActual - 120;
             });
             
             // Ordenar cronológicamente por hora (y por descripción como desempate)
             const eventosOrdenados = eventosFiltrados.slice().sort((a, b) => {
                 const aLocal = convertirHoraDesdeGMT0(String(a?.hour||''), -6);
                 const bLocal = convertirHoraDesdeGMT0(String(b?.hour||''), -6);
                 const tA = convertirHoraAMinutos(aLocal);
                 const tB = convertirHoraAMinutos(bLocal);
                 if (tA !== tB) return tA - tB;
                 const dA = String(a?.description||'');
                 const dB = String(b?.description||'');
                 return dA.localeCompare(dB);
             });
             
            // Limpiar contenedor existente
            if (tarjetasContainer) {
                tarjetasContainer.innerHTML = '';
            }
            
            if (eventosOrdenados.length === 0) {
                // Crear tarjeta especial si no hay eventos disponibles
                const tarjetaEspecial = document.createElement('div');
                tarjetaEspecial.className = 'google-tv-card tarjeta-especial';
                tarjetaEspecial.innerHTML = `
                    <div class="contenido-texto">
                        <h1>No hay eventos próximos</h1>
                        <h2>Los eventos de hoy ya han finalizado</h2>
                        <p>Vuelve mañana para ver nuevos partidos y eventos deportivos</p>
                    </div>
                `;
                tarjetasContainer.appendChild(tarjetaEspecial);
                return;
            }
            
            // Crear tarjetas para cada evento (ya ordenados)
            for (const evento of eventosOrdenados) {
                const tarjeta = await crearTarjetaDesdeAPI(evento);
                tarjeta.style.margin = '0';
                tarjeta.style.flexShrink = '0';
                tarjeta.style.flexBasis = '100%';
                tarjeta.style.width = '100%';
                tarjeta.style.minWidth = '100%';
                tarjeta.style.height = '100vh';
                tarjetasContainer.appendChild(tarjeta);
            }
              
              // Inicializar visibilidad de botones
              setTimeout(() => {
                  actualizarVisibilidadBotones();
              }, 100);
              
              console.log(`🎯 Carrusel creado con ${eventosOrdenados.length} eventos (fuente: Deporte-Libre)`);
              console.log(`🕐 Hora actual en Guatemala: ${horaGuatemala.toLocaleTimeString('es-GT', {timeZone: "America/Guatemala"})}`);
         }

        // Función para recargar datos de la API
        async function recargarDatosAPI() {
              console.log('🔄 Recargando datos de la API...');
              paginaActual = 0; // Resetear a la primera página
              await crearCarruselDinamico();
              actualizarFondoWrapper();
              
              // Reconfigurar eventos después de recargar
              configurarEventos();
              
              // Hacer focus en el primer botón
              setTimeout(() => {
                  const primerBoton = carruselContainer.querySelector('a[tabindex="0"], button[tabindex="0"]');
                  if (primerBoton) {
                      primerBoton.focus();
                  }
              }, 500);
          }

          // Función para recargar automáticamente cada 5 minutos
          function iniciarRecargaAutomatica() {
              setInterval(async () => {
                  console.log('⏰ Recarga automática de datos desde FTVHD API...');
                  await recargarDatosAPI();
              }, 300000); // 5 minutos = 300,000 ms
          }

          // Inicialización
          document.addEventListener('DOMContentLoaded', async function() {
              carruselContainer = document.getElementById('google-tv-carrusel');
              tarjetasContainer = document.getElementById('tarjetas-google-tv');
              configurarMenuSuperior();
              try { await inicializarPromoCarousel(); } catch(e){ console.warn('promo-carousel:', e); }
              
              // Crear carrusel dinámico con datos de la API
              await crearCarruselDinamico();
              
              configurarEventos();
              configurarNavegacionTeclado();
              iniciarAutoPlay();
              actualizarFondoWrapper();
              
              // Iniciar recarga automática
              iniciarRecargaAutomatica();
              
              // Hacer que el primer botón sea focusable por defecto
              setTimeout(() => {
                  const primerBoton = carruselContainer.querySelector('a[tabindex="0"], button[tabindex="0"]');
                  if (primerBoton) {
                      primerBoton.focus();
                  }
              }, 1000);
          });

        // Función para actualizar el fondo del wrapper
        function actualizarFondoWrapper() {
            const wrapper = document.querySelector('#wraper');
            if (!wrapper) return;
            
            const tarjetas = tarjetasContainer.querySelectorAll('.google-tv-card');
            if (tarjetas.length === 0 || paginaActual >= tarjetas.length) return;
            
            const tarjetaActual = tarjetas[paginaActual];
            const imagenFondo = tarjetaActual.getAttribute('data-imagen-fondo');
            
            if (imagenFondo) {
                // Detectar si es Android o dispositivo móvil
                const isAndroid = /Android/i.test(navigator.userAgent);
                const isMobile = /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent);
                const isTouchDevice = 'ontouchstart' in window;
                
                wrapper.style.background = `url('${imagenFondo}')`;
                wrapper.style.backgroundSize = '100% 100%';
                wrapper.style.backgroundPosition = 'center';
                wrapper.style.backgroundRepeat = 'no-repeat';
                
                // Usar 'scroll' en Android/móviles para mejor rendimiento
                if (isAndroid || isMobile || isTouchDevice) {
                    wrapper.style.backgroundAttachment = 'scroll';
                    wrapper.style.backgroundSize = 'cover';
                } else {
                    wrapper.style.backgroundAttachment = 'fixed';
                    wrapper.style.backgroundSize = '100% 100%';
                }
                
                console.log('🎨 Fondo del wrapper actualizado con imagen:', imagenFondo);
                console.log('📱 Dispositivo:', isAndroid ? 'Android' : isMobile ? 'Móvil' : 'Desktop');
                
                // Verificar tamaño de la imagen
                const img = new Image();
                img.onload = function() {
                    console.log('📏 Tamaño de imagen de fondo:', this.width + 'x' + this.height);
                };
                img.src = imagenFondo;
            }
        }

        // Función para ir a una página específica
        function irAPagina(pagina) {
             if (!tarjetasContainer) return;
             
             const tarjetas = tarjetasContainer.querySelectorAll('.google-tv-card');
             const totalTarjetas = tarjetas.length;
             
             if (totalTarjetas === 0) return;
             
             const nuevaPagina = Math.max(0, Math.min(pagina, totalTarjetas - 1));
             
             // Cambiar de página
             paginaActual = nuevaPagina;
             
             // Calcular el offset correctamente (cada tarjeta ocupa 100% del ancho)
             const offset = paginaActual * 100;
             
             // Aplicar la transformación con transición suave
             tarjetasContainer.style.transition = 'transform 0.8s ease';
             tarjetasContainer.style.transform = `translateX(-${offset}%)`;
             
             // Actualizar el fondo del wrapper después de la transición
             setTimeout(() => {
                 actualizarFondoWrapper();
             }, 800);
             
             console.log(`Página ${paginaActual + 1} de ${totalTarjetas}, offset: -${offset}%`);
             
             // Actualizar visibilidad de botones
             actualizarVisibilidadBotones();
         }

        // Función para ir a la siguiente página
        function siguientePagina() {
             if (!tarjetasContainer) return;
             
             const tarjetas = tarjetasContainer.querySelectorAll('.google-tv-card');
             const totalTarjetas = tarjetas.length;
             
             if (paginaActual < totalTarjetas - 1) {
                 irAPagina(paginaActual + 1);
             }
         }

         // Función para ir a la página anterior
         function paginaAnterior() {
             if (!tarjetasContainer) return;
             
             const tarjetas = tarjetasContainer.querySelectorAll('.google-tv-card');
             const totalTarjetas = tarjetas.length;
             
             if (paginaActual > 0) {
                 irAPagina(paginaActual - 1);
             }
         }

         // Función para actualizar visibilidad de botones
         function actualizarVisibilidadBotones() {
             const botonSiguiente = document.querySelector('.boton-siguiente-carrusel');
             const tarjetas = tarjetasContainer.querySelectorAll('.google-tv-card');
             const totalTarjetas = tarjetas.length;
             
             if (botonSiguiente) {
                 if (paginaActual === totalTarjetas - 1) {
                     botonSiguiente.style.opacity = '0.3';
                     botonSiguiente.style.pointerEvents = 'none';
                 } else {
                     botonSiguiente.style.opacity = '1';
                     botonSiguiente.style.pointerEvents = 'auto';
                 }
             }
             
             // Actualizar indicadores de página
             actualizarIndicadoresPagina();
         }

         // Función para actualizar indicadores de página
                 function actualizarIndicadoresPagina() {
            const indicadorContainer = document.getElementById('indicador-pagina');
            const tarjetas = tarjetasContainer.querySelectorAll('.google-tv-card');
            const totalTarjetas = tarjetas.length;
            
            if (!indicadorContainer || totalTarjetas === 0) return;
            
            // Limpiar indicadores existentes
            indicadorContainer.innerHTML = '';
            
            // Crear indicadores para cada página (máximo 3)
            const maxIndicadores = Math.min(totalTarjetas, 3);
            for (let i = 0; i < maxIndicadores; i++) {
                 const indicador = document.createElement('div');
                 // Lógica circular para el indicador activo
                 const indicadorActivo = paginaActual % maxIndicadores;
                 indicador.style.cssText = `
                     width: 12px;
                     height: 12px;
                     border-radius: 50%;
                     background: ${i === indicadorActivo ? 'rgba(255, 255, 255, 0.8)' : 'rgba(255, 255, 255, 0.3)'};
                     cursor: pointer;
                     transition: all 0.3s ease;
                 `;
                 
                 indicador.addEventListener('click', () => {
                     // Navegación circular en los indicadores
                     if (i === 0 && paginaActual === totalTarjetas - 1) {
                         // Si está en la última página y hace clic en el primer indicador, va al principio
                         irAPagina(0);
                     } else if (i === maxIndicadores - 1 && paginaActual === 0) {
                         // Si está en la primera página y hace clic en el último indicador, va al final
                         irAPagina(totalTarjetas - 1);
                     } else {
                         irAPagina(i);
                     }
                 });
                 
                 indicador.addEventListener('mouseenter', () => {
                     if (i !== indicadorActivo) {
                         indicador.style.background = 'rgba(255, 255, 255, 0.6)';
                     }
                 });
                 
                 indicador.addEventListener('mouseleave', () => {
                     if (i !== indicadorActivo) {
                         indicador.style.background = 'rgba(255, 255, 255, 0.3)';
                     }
                 });
                 
                 indicadorContainer.appendChild(indicador);
             }
         }

        // Función para configurar eventos
        function configurarEventos() {

                          // Botón siguiente
             const botonSiguiente = document.querySelector('.boton-siguiente-carrusel');
             if (botonSiguiente) {
                 botonSiguiente.addEventListener('click', function() {
                     siguientePagina();
                     registrarActividad();
                 });

                 // Permitir Enter/Espacio para navegar
                 botonSiguiente.addEventListener('keydown', function(e) {
                     if (e.key === 'Enter' || e.key === ' ') {
                         e.preventDefault();
                         siguientePagina();
                         registrarActividad();
                     }
                 });
             }

            // Eventos de foco
            carruselContainer.addEventListener('focusin', function(e) {
                if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('a, button')) {
                    hayFoco = true;
                    detenerAutoPlay();
                }
            });

            carruselContainer.addEventListener('focusout', function(e) {
                setTimeout(() => {
                    const elementoActivo = document.activeElement;
                    if (!elementoActivo || !carruselContainer.contains(elementoActivo)) {
                        hayFoco = false;
                        iniciarAutoPlay();
                    }
                }, 100);
            });

            // Eventos de mouse
            carruselContainer.addEventListener('mouseenter', function() {
                hayFoco = true;
                detenerAutoPlay();
                registrarActividad();
            });

            carruselContainer.addEventListener('mouseleave', function() {
                hayFoco = false;
                iniciarAutoPlay();
                registrarActividad();
            });

            // Eventos de interacción
            carruselContainer.addEventListener('click', registrarActividad);
            carruselContainer.addEventListener('mousemove', registrarActividad);
            carruselContainer.addEventListener('keydown', registrarActividad);
        }

        // Función para configurar navegación por teclado
        function configurarNavegacionTeclado() {
                     // Detectar si es WebView (mejorado para Android)
        const isWebView = /wv|WebView|Android.*Chrome/i.test(navigator.userAgent) || 
                         (navigator.userAgent.includes('Android') && navigator.userAgent.includes('Chrome'));
        
        // Log para debug
        console.log('📱 WebView detectado:', isWebView);
        console.log('🔧 User Agent:', navigator.userAgent);
        console.log('🌐 Platform:', navigator.platform);
        console.log('📱 User Agent Data:', navigator.userAgentData);
             
             document.addEventListener('keydown', function(e) {
                 const esBotonCarrusel = document.activeElement && document.activeElement.classList && document.activeElement.classList.contains('boton-siguiente-carrusel');
                 
                 // Tecla R para recargar datos de la API
                 if (e.key === 'r' || e.key === 'R') {
                     e.preventDefault();
                     console.log('🔄 Recarga manual solicitada con tecla R');
                     recargarDatosAPI();
                     registrarActividad();
                     return;
                 }
                 
                 // Sistema de navegación específico por niveles
                 const focused = document.activeElement;

                 // 🔹 Navegación del carrusel (solo desde el botón siguiente)
                 if (esBotonCarrusel) {
                     if (e.key === 'ArrowLeft') {
                         e.preventDefault();
                         e.stopImmediatePropagation();
                         paginaAnterior();
                         registrarActividad();
                         return;
                     }
                     
                     if (e.key === 'ArrowRight') {
                         e.preventDefault();
                         e.stopImmediatePropagation();
                         siguientePagina();
                         registrarActividad();
                         return;
                     }
                     
                     if (e.key === 'ArrowUp') {
                         e.preventDefault();
                         const primerBotonMenu = document.querySelector('.menu-button');
                         if (primerBotonMenu) primerBotonMenu.focus();
                     }
                     
                     if (e.key === 'ArrowDown') {
                         e.preventDefault();
                         setTimeout(() => {
                             const tarjetas = carruselContainer.querySelectorAll('.google-tv-card');
                             if (tarjetas[paginaActual]) {
                                 const primerBoton = tarjetas[paginaActual].querySelector('a[tabindex="0"], button[tabindex="0"]');
                                 if (primerBoton) primerBoton.focus();
                             }
                         }, 0);
                     }
                     return; // Solo manejar navegación del carrusel
                 }

                 // 🔹 Navegación en el menú superior
                 const esBotonMenu = focused && focused.classList && focused.classList.contains('menu-button');
                 if (esBotonMenu) {
                     const menuButtons = Array.from(document.querySelectorAll('.menu-button'));
                     const indexMenu = menuButtons.indexOf(focused);
                     
                     if (e.key === "ArrowLeft" && indexMenu > 0) {
                         e.preventDefault();
                         e.stopImmediatePropagation();
                         menuButtons.forEach(b => b.classList.remove('active'));
                         menuButtons[indexMenu - 1].classList.add('active');
                         menuButtons[indexMenu - 1].focus();
                         return;
                     }
                     
                     if (e.key === "ArrowRight" && indexMenu < menuButtons.length - 1) {
                         e.preventDefault();
                         e.stopImmediatePropagation();
                         menuButtons.forEach(b => b.classList.remove('active'));
                         menuButtons[indexMenu + 1].classList.add('active');
                         menuButtons[indexMenu + 1].focus();
                         return;
                     }
                     
                     if (e.key === "ArrowDown") {
                         e.preventDefault();
                         e.stopImmediatePropagation();
                         const botonSiguiente = document.querySelector('.boton-siguiente-carrusel');
                         if (botonSiguiente) botonSiguiente.focus();
                         return;
                     }
                     
                     return; // Solo manejar flechas arriba/abajo en el menú
                 }

                 // 🔹 Navegación en botones de canal
                 const esBotonCanal = focused && focused.tagName === 'A' && focused.closest('.botones-container');
                 if (esBotonCanal) {
                     const tarjetaActual = focused.closest('.google-tv-card');
                     const botonesCanalActual = Array.from(tarjetaActual.querySelectorAll('.botones-container a[role="button"]'));
                     const indexCanal = botonesCanalActual.indexOf(focused);

                     if (e.key === "ArrowLeft" && indexCanal > 0) {
                         e.preventDefault();
                         e.stopImmediatePropagation();
                         botonesCanalActual[indexCanal - 1].focus();
                         return;
                     }
                     
                     if (e.key === "ArrowRight" && indexCanal < botonesCanalActual.length - 1) {
                         e.preventDefault();
                         e.stopImmediatePropagation();
                         botonesCanalActual[indexCanal + 1].focus();
                         return;
                     }
                     
                     if (e.key === "ArrowDown") {
                         e.preventDefault();
                         e.stopImmediatePropagation();
                         const promoContainer = document.getElementById('promo-carousel');
                         if (promoContainer && !promoContainer.hidden) {
                             const dots = Array.from(promoContainer.querySelectorAll('#promoDots .promo-dot'));
                             const activeIndex = dots.findIndex(d => d.classList.contains('active'));
                             const slides = Array.from(promoContainer.querySelectorAll('#promoTrack .promo-slide'));
                             const targetSlide = activeIndex >= 0 ? slides[activeIndex] : slides[0];
                             const targetCard = targetSlide ? targetSlide.querySelector('promo-match-card') : null;
                             if (targetCard) targetCard.focus();
                         }
                         return;
                     }
                     
                     if (e.key === "ArrowUp") {
                         e.preventDefault();
                         e.stopImmediatePropagation();
                         const botonSiguiente = document.querySelector('.boton-siguiente-carrusel');
                         if (botonSiguiente) botonSiguiente.focus();
                         return;
                     }
                     
                     return; // Solo manejar flechas izquierda/derecha en botones de canal
                 }
                 
                 // Navegación desde el menú superior (manejada en el sistema principal)
                 
                 if (e.key === 'Tab') {
                     registrarActividad();
                 }
             });
         }

        // Función para iniciar auto-play
        function iniciarAutoPlay() {
            if (hayFoco) return;
            
            detenerAutoPlay();
            iniciarTimerInactividad();
        }

        // Función para detener auto-play
        function detenerAutoPlay() {
            if (autoPlayInterval) {
                clearInterval(autoPlayInterval);
                autoPlayInterval = null;
            }
        }

        // Función para registrar actividad
        function registrarActividad() {
            ultimaActividad = Date.now();
            reiniciarTimerInactividad();
        }

        // Función para iniciar timer de inactividad
        function iniciarTimerInactividad() {
            reiniciarTimerInactividad();
        }

        // Función para reiniciar timer de inactividad
        function reiniciarTimerInactividad() {
            if (inactividadTimer) {
                clearTimeout(inactividadTimer);
            }
            
            inactividadTimer = setTimeout(() => {
                console.log('Inactividad detectada, pasando al siguiente evento automáticamente');
                siguientePagina();
                const tarjetas = tarjetasContainer.querySelectorAll('.google-tv-card');
                const totalTarjetas = tarjetas.length;
                if (paginaActual < totalTarjetas - 1) {
                    reiniciarTimerInactividad();
                }
            }, 60000); // 60 segundos
        }

        // Configurar menú superior
        function configurarMenuSuperior() {
            const menuButtons = document.querySelectorAll('.menu-button');
            menuButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    menuButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
                btn.addEventListener('focus', () => detenerAutoPlay());
                btn.addEventListener('blur', () => {
                    iniciarAutoPlay();
                    // Limpiar clase active cuando se sale del menú
                    setTimeout(() => {
                        const elementoActivo = document.activeElement;
                        if (!elementoActivo || !elementoActivo.classList.contains('menu-button')) {
                            menuButtons.forEach(b => b.classList.remove('active'));
                        }
                    }, 100);
                });
            });
        }

        // El sistema de navegación tipo Google TV se maneja en configurarNavegacionTeclado()
    </script>
    <!-- Lógica del promo-carousel: usa API Unidad Editorial del día siguiente y crea tarjetas tipo promo-match-card -->
    <script>
    async function inicializarPromoCarousel(){
        const container = document.getElementById('promo-carousel');
        const track = document.getElementById('promoTrack');
        const dots = document.getElementById('promoDots');
        if (!container || !track || !dots) return;

        // Fecha de mañana en formato YYYY-MM-DD
        const now = new Date();
        const tomorrow = new Date(now.getTime() + 24*60*60*1000);
        const yyyy = tomorrow.getFullYear();
        const mm = String(tomorrow.getMonth()+1).padStart(2,'0');
        const dd = String(tomorrow.getDate()).padStart(2,'0');
        const dateStr = `${yyyy}-${mm}-${dd}`;
        const tz = -6; // Guatemala

        // Cargar datos de la API con proxy para WebView
        let events = [];
        
        // Detectar si es WebView
        const isWebView = /wv|WebView|Android.*Chrome/i.test(navigator.userAgent) || 
                         (navigator.userAgent.includes('Android') && navigator.userAgent.includes('Chrome'));
        
        // Intentar API directa primero (con reintentos + fallback proxy)
        const url = `https://api.unidadeditorial.es/sports/v1/events/preset/1_99a16e5b?timezoneOffset=${tz}&date=${dateStr}`;
        const maxIntentosUE = 5;
        const baseDelayUE = 800;
        let cargado = false;
        for (let intento = 1; intento <= maxIntentosUE && !cargado; intento++) {
            try {
                console.log(`🔄 UE intento ${intento}/${maxIntentosUE}: directo`);
                let r = await fetch(url, { cache: 'no-store' });
                if (!r.ok) throw new Error('HTTP '+r.status);
                let j = await r.json();
                events = Array.isArray(j.data) ? j.data : [];
                events = events.filter(ev => (ev?.sport?.id === '01') || /fútbol|soccer/i.test(ev?.sport?.name || ''));
                if (events.length) { console.log('✅ UE directo OK'); cargado = true; break; }
                console.warn('⚠️ UE directo sin datos; probando proxy...');
            } catch(err){
                console.warn('UE directo falló:', err);
            }
            // Proxy
            try {
                console.log(`🔄 UE intento ${intento}/${maxIntentosUE}: proxy AllOrigins`);
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                let rp = await fetch(proxyUrl, { cache: 'no-store' });
                if (!rp.ok) throw new Error('HTTP '+rp.status);
                let jp = await rp.json();
                events = Array.isArray(jp.data) ? jp.data : [];
                events = events.filter(ev => (ev?.sport?.id === '01') || /fútbol|soccer/i.test(ev?.sport?.name || ''));
                if (events.length) { console.log('✅ UE proxy OK'); cargado = true; break; }
                console.warn('⚠️ UE proxy sin datos');
            } catch(proxyErr){
                console.warn('UE proxy falló:', proxyErr);
            }
            await esperar(baseDelayUE * intento);
        }
        if (!cargado || !events.length) return;

        // Limpiar y construir
        track.innerHTML = '';
        dots.innerHTML = '';
        container.hidden = false;

        const toLocal = (iso)=>{
            try {
                const utc = new Date(iso);
                const shifted = new Date(utc.getTime() + tz * 60 * 60 * 1000);
                return shifted.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit', hour12:true, timeZone:'UTC' });
            } catch { return ''; }
        };

        const slides = events.map(ev => {
            const leftName = (ev?.sportEvent?.name||'').split(' vs ')[0]?.replace(/^.*?(?=\b[A-Z][a-z]+\b)/,'').replace(/^Previa Champions League |^Previa |^Libertadores |^CONMEBOL |^La Liga |^Liga |^Premier League |^Serie A |^Bundesliga |^Ligue 1 |^Eredivisie |^Primeira Liga |^Champions League |^UEFA |^Europa League |^Conference League |^Copa del Rey |^FA Cup |^Coppa Italia |^DFB Pokal |^Coupe de France |^Fútbol /gi,'').trim() || '';
            const rightName = (ev?.sportEvent?.name||'').split(' vs ')[1]?.replace(/^.*?(?=\b[A-Z][a-z]+\b)/,'').replace(/^Previa Champions League |^Previa |^Libertadores |^CONMEBOL |^La Liga |^Liga |^Premier League |^Serie A |^Bundesliga |^Ligue 1 |^Eredivisie |^Primeira Liga |^Champions League |^UEFA |^Europa League |^Conference League |^Copa del Rey |^FA Cup |^Coppa Italia |^DFB Pokal |^Coupe de France |^Fútbol /gi,'').trim() || '';
            const timeText = toLocal(ev?.startDate);
            const comp = ev?.tournament?.name || ev?.sport?.name || '';
            const leftLogo = ev?.sportEvent?.competitors?.homeTeam?.imageUrl || '';
            const rightLogo = ev?.sportEvent?.competitors?.awayTeam?.imageUrl || '';

            const slide = document.createElement('div');
            slide.className = 'promo-slide';

            const card = document.createElement('promo-match-card');
            card.setAttribute('left-name', leftName.trim());
            card.setAttribute('right-name', rightName.trim());
            card.setAttribute('time', timeText);
            card.setAttribute('comp', comp);
            if (leftLogo) card.setAttribute('left-logo', leftLogo);
            if (rightLogo) card.setAttribute('right-logo', rightLogo);
            card.setAttribute('tabindex', '0');
            card.setAttribute('role', 'button');
            card.setAttribute('aria-label', `${leftName.trim()} vs ${rightName.trim()} - ${timeText}`);
            slide.appendChild(card);
            return slide;
        });

        slides.forEach(s => track.appendChild(s));

        // Navegación
        let idx = 0;
        const total = slides.length;
        function update(){
            track.style.transform = `translateX(-${idx*100}%)`;
            Array.from(dots.children).forEach((d,i)=>d.classList.toggle('active', i===idx));
        }
        for(let i=0;i<total;i++){
            const d = document.createElement('div');
            d.className = 'promo-dot' + (i===0?' active':'');
            d.addEventListener('click', ()=>{ idx=i; update(); });
            dots.appendChild(d);
        }
        document.getElementById('promoPrev')?.addEventListener('click', ()=>{ idx = (idx-1+total)%total; update(); });
        document.getElementById('promoNext')?.addEventListener('click', ()=>{ idx = (idx+1)%total; update(); });
        document.querySelector('#promo-carousel .promo-close')?.addEventListener('click', ()=>{ container.hidden = true; });

        // Navegación por teclado para las tarjetas de promo
        container.addEventListener('keydown', (e) => {
            const focusedCard = container.querySelector('promo-match-card:focus');
            if (!focusedCard) return;
            
            const currentSlide = focusedCard.closest('.promo-slide');
            const currentIndex = Array.from(track.children).indexOf(currentSlide);
            
            switch(e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    // Subir foco a los botones de canal de la tarjeta actual del carrusel principal
                    try {
                        const tarjetas = carruselContainer.querySelectorAll('.google-tv-card');
                        if (tarjetas[paginaActual]) {
                            const primerBoton = tarjetas[paginaActual].querySelector('.botones-container a[tabindex="0"], .botones-container button[tabindex="0"]');
                            if (primerBoton) primerBoton.focus();
                        }
                    } catch(_) {}
                    break;
                case 'Enter':
                    e.preventDefault();
                    // Hacer fade out de la tarjeta actual
                    const currentCard = focusedCard;
                    const currentTextElements = currentCard.shadowRoot.querySelectorAll('.team-name, .vs, .time-big, .time-sub');
                    currentTextElements.forEach(el => {
                        el.style.animation = 'fadeOut 0.5s ease-in-out forwards';
                    });
                    
                    // Hacer fade out del fondo del promo-carousel
                    const promoCarousel = document.querySelector('#promo-carousel');
                    if (promoCarousel) {
                        promoCarousel.style.transition = 'opacity 0.5s ease-in-out';
                        promoCarousel.style.opacity = '0';
                    }
                    
                    // Navegar al siguiente slide después del fade out
                    setTimeout(() => {
                        idx = (idx + 1) % total;
                        update();
                        
                        // Mantener el foco en la tarjeta actual y hacer fade in
                        setTimeout(() => {
                            const newSlide = track.children[idx];
                            if (newSlide) {
                                const newCard = newSlide.querySelector('promo-match-card');
                                if (newCard) {
                                    newCard.focus();
                                    // Reiniciar animación del texto con fade in
                                    const textElements = newCard.shadowRoot.querySelectorAll('.team-name, .vs, .time-big, .time-sub');
                                    textElements.forEach(el => {
                                        el.style.animation = 'none';
                                        el.offsetHeight; // Trigger reflow
                                        el.style.animation = 'fadeIn 1s ease-in-out forwards';
                                    });
                                }
                            }
                            
                            // Hacer fade in del fondo del promo-carousel
                            if (promoCarousel) {
                                promoCarousel.style.opacity = '1';
                            }
                        }, 100);
                    }, 500);
                    break;
            }
        });

        update();

        // Auto-play ultra simple para WebView
        let promoAutoPlayInterval = null;

        function startPromoAutoPlay() {
            if (promoAutoPlayInterval) return;
            console.log('🔄 Iniciando auto-play del promo-carousel');
            
            // Usar setInterval simple (más compatible con WebView)
            promoAutoPlayInterval = setInterval(() => {
                if (total > 1) {
                    console.log('⏰ Auto-play: cambiando tarjeta del promo-carousel');
                    idx = (idx + 1) % total;
                    update();
                }
            }, 10000);
        }

        function stopPromoAutoPlay() {
            if (promoAutoPlayInterval) {
                clearInterval(promoAutoPlayInterval);
                promoAutoPlayInterval = null;
                console.log('⏹️ Auto-play detenido');
            }
        }

        // Detectar foco de forma más simple
        container.addEventListener('focusin', stopPromoAutoPlay);
        container.addEventListener('focusout', startPromoAutoPlay);

        // Iniciar auto-play después de 30 segundos
        setTimeout(startPromoAutoPlay, 30000);

        // Actualización diaria automática
        const msToMidnight = (()=>{
            const n = new Date();
            const m = new Date(n.getFullYear(), n.getMonth(), n.getDate()+1, 0, 0, 5); // 00:00:05
            return m - n;
        })();
        setTimeout(()=>{ inicializarPromoCarousel(); }, msToMidnight);
    }
    </script>
    
    <!-- Promo match card web component: reusable, encapsulated, safe to insert anywhere -->
    <script>
    (function(){
        class PromoMatchCard extends HTMLElement {
            static get observedAttributes(){
                return ['left-name','right-name','time','comp','left-logo','right-logo','center-logo'];
            }
            constructor(){
                super();
                this._root = this.attachShadow({mode:'open'});
                this._render();
            }
            attributeChangedCallback(){ this._render(); }
            _val(name, def=''){ return this.getAttribute(name) || def; }
            _render(){
                const leftName = this._val('left-name');
                const rightName = this._val('right-name');
                const timeText = this._val('time');
                const compText = this._val('comp');
                const leftLogo = this._val('left-logo');
                const rightLogo = this._val('right-logo');
                const centerLogo = this._val('center-logo', 'https://upload.wikimedia.org/wikipedia/commons/3/3b/UEFA_Champions_League_logo_2.svg');
                this._root.innerHTML = `
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                    :host{ display:block; outline: none; -webkit-tap-highlight-color: transparent; }
                    :host(:focus), :host(:focus-visible), :host(:focus-within){ outline: none !important; box-shadow: none !important; }
                    .promo-card{ background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.08); border-radius:48px; overflow:hidden; padding:0; color:#fff; font-family: inherit; transition: all 0.3s ease; cursor: pointer; }
                    .promo-card:hover, .promo-card:focus-within{ transform: scale(1.05); border-color: rgba(255,255,255,0.08); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
                    :host(:focus) .promo-card, :host(:focus-visible) .promo-card { transform: scale(1.05); border-color: rgba(255,255,255,0.08); box-shadow: 0 8px 25px rgba(0,0,0,0.3); outline: none; }
                    .promo-top{ display:grid; grid-template-columns:1fr 140px 1fr; min-height:140px; }
                    .panel{ display:flex; flex-direction:column; justify-content:center; align-items:center; gap:6px; padding:16px 12px; }
                    .panel-left{ background:transparent; color:#fff; }
                    .panel-right{ background:transparent; color:#fff; }
                    .panel-center{ background:transparent; color:#fff; }
                    .team-logo{ width:44px; height:44px; object-fit:contain; }
                    .team-name{ font-weight:900; font-size:clamp(18px,4vw,34px); line-height:1; text-align:center; letter-spacing:.5px; opacity: 0; animation: fadeIn 1s ease-in-out forwards; }
                    .vs{ margin-top:10px; font-weight:800; letter-spacing:2px; font-size:clamp(24px,6vw,48px); text-align:center; opacity: 0; animation: fadeIn 1s ease-in-out forwards; }
                    .promo-bottom{ background:#0b0b0b; display:flex; align-items:center; justify-content:center; padding:8px; gap:10px; }
                    .time-big{ font-weight:900; font-size:clamp(18px,4.6vw,28px); letter-spacing:.5px; opacity: 0; animation: fadeIn 1s ease-in-out forwards; }
                    .time-sub{ font-size:12px; color:#cfcfcf; opacity: 0; animation: fadeIn 1s ease-in-out forwards; }
                </style>
                <div class="promo-card" part="card">
                    <div class="promo-top" part="top">
                        <div class="panel panel-left" part="left">
                            ${leftLogo?`<img class=\"team-logo\" src=\"${leftLogo}\" alt=\"\">`:''}
                            <div class="team-name">${leftName}</div>
                        </div>
                        <div class="panel panel-center" part="center">
                            <div class="vs">VS</div>
                        </div>
                        <div class="panel panel-right" part="right">
                            ${rightLogo?`<img class=\"team-logo\" src=\"${rightLogo}\" alt=\"\">`:''}
                            <div class="team-name">${rightName}</div>
                        </div>
                    </div>
                    <div class="promo-bottom" part="bottom">
                        <div class="time-big">${timeText}</div>
                        ${compText?`<div class=\"time-sub\">${compText}</div>`:''}
                    </div>
                </div>`;
            }
        }
        if (!customElements.get('promo-match-card')) customElements.define('promo-match-card', PromoMatchCard);
    })();
    </script>
</body>
</html>
